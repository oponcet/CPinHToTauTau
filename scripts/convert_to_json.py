import os
import re
import sys
import correctionlib.convert as convert
import boost_histogram as bh
import aghast
import uproot
import rich


#corr = convert.from_uproot_THx("zpt_reweighting_LO.root:zptmass_histo")
#from IPython import embed; embed()

import correctionlib.schemav2 as cs
import rich

corr2 = cs.Correction(
    name="zptreweight",
    version=1,
    inputs=[
        cs.Variable(name="mass", type="real", description="Z mass"),
        cs.Variable(name="pt",   type="real", description="Z pt"),
    ],
    output=cs.Variable(name="weight", type="real", description="Multiplicative event weight"),
    data=cs.MultiBinning(
        nodetype="multibinning",
        inputs=["mass","pt"],
        edges=[[0.0, 50.0, 60.0, 70.0, 80.0, 90.0, 100.0, 120.0, 140.0, 160.0, 180.0, 200.0, 300.0, 400.0, 600.0, 800.0, 1000.0], 
               [0.0, 10.0, 20.0, 30.0, 40.0, 60.0, 80.0, 100.0, 120.0, 160.0, 200.0, 280.0, 320.0, 400.0, 600.0]],
        content=[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8428496031744795, 1.1110643915398508, 1.1539411823686425, 1.1835457445582238, 1.2736849242989094, 1.292760394820865, 1.3284170828581816, 1.2522225306398462, 1.3728552640869407, 1.2387962636183123, 1.16000407242509, 1.4479361420740127, 1.5740095138780117, 2.3314371817610744, 0.8348026214827654, 1.0231994843774512, 1.099067220062927, 1.200860059343058, 1.241129221278812, 1.2854314016672344, 1.2482067101951855, 1.2087684960068066, 1.237856900180634, 1.33080637372519, 1.2738189677308807, 1.48966616130713, 1.4197918488598313, 1.3945267429064094, 0.8589560983703027, 1.0002057317241928, 1.1468488109990524, 1.1989723246211914, 1.225695924369317, 1.2929343081940297, 1.3224360781983888, 1.3439938048277, 1.3233407311562346, 1.3039372598915107, 1.2847275120880304, 1.238215350122328, 1.398898959097679, 1.1753710238871706, 0.883527446310665, 1.0957265801119405, 1.1927633807744844, 1.2289930536693614, 1.2745856044230712, 1.349047423670248, 1.3886170675018519, 1.4097712951795447, 1.4170120893711113, 1.3674975482138418, 1.3870380179335071, 1.34897186378525, 1.354394469558453, 1.3552359300051187, 0.8213879172222471, 1.0212849601733147, 1.1028869960849064, 1.1362539212849356, 1.1804769098341743, 1.2498809753353406, 1.293588578294681, 1.310383822953584, 1.3136230379179477, 1.2896719440004958, 1.3035179830069765, 1.2602499665384261, 1.2255649289250192, 1.1631052585360584, 0.8280364772273066, 1.032007171566805, 1.1157882335594487, 1.1490368350267368, 1.1830073365812963, 1.215062424825995, 1.2399169740662668, 1.251955548360181, 1.2982200424153416, 1.3152358024113469, 1.3227133909120943, 1.1824443259421245, 1.2067233870240448, 1.4453566211202908, 0.8226179383810072, 1.0017872603355018, 1.1042375783034863, 1.1336788445845307, 1.1261282111276236, 1.1307833548701207, 1.103260806473426, 1.0871518774883766, 1.1285085575370832, 1.1841127402489204, 1.31932085859792, 1.3460445812393032, 1.2988012166487761, 1.187320098559063, 0.8294633910000256, 0.9955543187832139, 1.094307159418913, 1.115381599714378, 1.0842196000765218, 1.0599892281608163, 0.953684510115952, 1.0364856155679139, 1.0707875709836145, 1.0523792930435554, 1.1438036796414222, 1.4143002671142815, 1.2721472578242203, 1.0780765340290814, 0.8311060941398766, 0.9971973495370273, 1.106506462228179, 1.0869795760756582, 1.0763647936465193, 0.973164929829901, 0.807396305021295, 0.9162113669485976, 0.8547426522138939, 0.9451008582595286, 1.2566384229545786, 1.3476659005098346, 1.1273280121126663, 0.8413357488593195, 0.8520208769738554, 1.0025424024928715, 1.0974791074044061, 1.072623512938462, 1.1060392352555226, 0.8613890085226945, 0.7816167808144557, 0.676741891806201, 0.8290499759714001, 0.7787318268234119, 1.2498525496488837, 1.3532584792633164, 1.6371988638886088, 1.2917609335186282, 0.8402467161339413, 0.9733333969192637, 1.1409861518700026, 1.1813981880906541, 1.068128178395016, 0.9045047176858099, 0.8612239737240892, 0.7617741938068849, 0.8859689897299625, 0.8549921571643582, 1.006597138210978, 1.1535800640567957, 0.900883739919009, 1.0511109539600985, 0.881664669480096, 0.9853552914938561, 1.126886015998676, 1.2782620769367397, 1.178577456787246, 1.3071140299044242, 0.9794598457061345, 0.7283517843519097, 0.6269855260586006, 1.0380270061922097, 0.5748292102884882, 0.42324571700291225, 0.9046025029051681, 1.4960241010450728, 0.8166662300260582, 0.9980288356288198, 1.1241539364416833, 1.5101329154302143, 1.3429442908116365, 1.3737162239413256, 1.4217597842115302, 1.2421392867290701, 0.7327197705357272, 0.9703359022005271, 0.7934641524093111, -0.004862876519090621, 0.8250751201808126, 1.2596092813260862, 1.0308048439661377, 1.2379277906808308, 1.434218431635166, 1.85213537352731, 1.3100019242266752, 1.603342298424, 1.3264634834484206, 1.328563124105096, 1.2796439526580958, 1.3857377717838917, 1.3747783311049575, 1.8376466497313524, 0.801505730589609, 0.9028855482633115, 0.8329863523867426, 0.9926626312304617, 0.8674120795413376, 1.307379935409027, 1.6063378971363285, 2.652679718891184, 2.5345023399807527, 1.88871650744086, 1.6377256204906738, 1.432039479636607, 1.1940043624913979, -0.00496700727983777, -0.050563815940956165, 1.6590435557499679],
        flow="error",
    ),
)


rich.print(corr2)



cset = cs.CorrectionSet(
    schema_version=2,
    description="my custom Zpt reweighting",
    corrections=[
        corr2,
    ],
)

with open("myZptCorrections.json", "w") as fout:
    fout.write(cset.json(exclude_unset=True, indent=4))

import gzip

with gzip.open("myZptCorrections.json.gz", "wt") as fout:
    fout.write(cset.json(exclude_unset=True, indent=4))
